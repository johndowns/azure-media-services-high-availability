    {
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "stamps": {
            "type": "array"
        },
        "resourceNamePrefix": {
            "type": "string",
            "defaultValue": "[uniqueString(subscription().subscriptionId, resourceGroup().name)]"
        }
    },
    "variables": {
        "applicationInsightsResourceName": "MediaEncoding"
    },
    "resources": [
        {
            "name": "[variables('applicationInsightsResourceName')]",
            "type": "Microsoft.Insights/components",
            "location": "[resourceGroup().location]",
            "apiVersion": "2015-05-01",
            "kind": "web",
            "properties": {
                "Application_Type": "web"
            }
        },

        {
            "name": "allStamps",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-05-01",
            "properties": {
                "mode": "Incremental",
                "expressionEvaluationOptions": {
                    "scope": "inner"    
                },
                "parameters": {
                    "stamps": {
                        "value": "[parameters('stamps')]"
                    },
                    "resourceNamePrefix": {
                        "value": "[parameters('resourceNamePrefix')]"
                    }
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "stamps": {
                            "type": "array"
                        },
                        "resourceNamePrefix": {
                            "type": "string"
                        }
                    },
                    "resources": [
                        {
                            "name": "[concat('stampTemplate-', parameters('stamps')[copyIndex('stampsCopy')].resourceNameSuffix)]",
                            "type": "Microsoft.Resources/deployments",
                            "apiVersion": "2019-05-01",
                            "copy": {
                                "name": "stampsCopy",
                                "count": "[length(parameters('stamps'))]"
                            },
                            "properties": {
                                "mode": "Incremental",
                                "expressionEvaluationOptions": {
                                    "scope": "inner"    
                                },
                                "parameters": {
                                    "regionId": {
                                        "value": "[parameters('stamps')[copyIndex('stampsCopy')].regionId]"
                                    },
                                    "resourceNamePrefix": {
                                        "value": "[parameters('resourceNamePrefix')]"
                                    },
                                    "resourceNameSuffix":  {
                                        "value": "[parameters('stamps')[copyIndex('stampsCopy')].resourceNameSuffix]"
                                    }
                                },
                                "template": {
                                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                                    "contentVersion": "1.0.0.0",
                                    "parameters": {
                                        "regionId": {
                                            "type": "string",
                                            "defaultValue": "[resourceGroup().location]"
                                        },
                                        "resourceNamePrefix": {
                                            "type": "string"
                                        },
                                        "resourceNameSuffix": {
                                            "type": "string"
                                        }
                                    },
                                    "variables": {
                                        "ingestionStorageAccountName": "[concat(parameters('resourceNamePrefix'), 'ingst', parameters('resourceNameSuffix'))]",
                                        "ingestionCdnProfileName": "[concat(parameters('resourceNamePrefix'), 'ingcdnprofile', parameters('resourceNameSuffix'))]",
                                        "ingestionCdnEndpointName": "[concat(parameters('resourceNamePrefix'), 'ingcdn', parameters('resourceNameSuffix'))]",
                                        "appServicePlanName": "[concat(parameters('resourceNamePrefix'), 'asp', parameters('resourceNameSuffix'))]",
                                        "functionStorageAccountName": "[concat(parameters('resourceNamePrefix'), 'fnst', parameters('resourceNameSuffix'))]",
                                        "functionStorageAccountId": "[resourceId('Microsoft.Storage/storageAccounts', variables('functionStorageAccountName'))]",
                                        "functionAppName": "[concat(parameters('resourceNamePrefix'), 'fn', parameters('resourceNameSuffix'))]",
                                        "mediaEncodingStorageAccountName": "[concat(parameters('resourceNamePrefix'), 'amsst', parameters('resourceNameSuffix'))]",
                                        "mediaServicesName": "[concat(parameters('resourceNamePrefix'), 'ams', parameters('resourceNameSuffix'))]",
                                        "mediaServicesEventGridSubscriptionName": "job-status-updates"
                                    },
                                    "resources": [
                                        {
                                            "name": "[variables('ingestionStorageAccountName')]",
                                            "type": "Microsoft.Storage/storageAccounts",
                                            "apiVersion": "2016-01-01",
                                            "location": "[parameters('regionId')]",
                                            "kind": "Storage",
                                            "sku": {
                                                "name": "Standard_LRS"
                                            }
                                        },
                                        {
                                            "name": "[variables('ingestionCdnProfileName')]",
                                            "type": "Microsoft.Cdn/profiles",
                                            "apiVersion": "2016-04-02",
                                            "location": "[parameters('regionId')]",
                                            "sku": {
                                                "name": "Standard_Akamai"
                                            },
                                            "resources": [
                                                {
                                                    "name": "[variables('ingestionCdnProfileName')]",
                                                    "type": "endpoints",
                                                    "apiVersion": "2019-04-15",
                                                    "location": "[parameters('regionId')]",
                                                    "properties": {
                                                        "originHostHeader": "[replace(replace(reference(variables('ingestionStorageAccountName')).primaryEndpoints.blob, 'https://', ''), '/', '')]",
                                                        "isHttpAllowed": false,
                                                        "isHttpsAllowed": true,
                                                        "origins": [
                                                            {
                                                                "name": "ingestionBlobStorageEndpoint",
                                                                "properties": {
                                                                    "hostName": "[replace(replace(reference(variables('ingestionStorageAccountName')).primaryEndpoints.blob, 'https://', ''), '/', '')]"
                                                                }
                                                            }
                                                        ]
                                                    },
                                                    "dependsOn": [
                                                        "[resourceId('Microsoft.Cdn/profiles', variables('ingestionCdnProfileName'))]",
                                                        "[resourceId('Microsoft.Storage/storageAccounts', variables('ingestionStorageAccountName'))]"
                                                    ]
                                                }
                                            ]
                                        },
                                
                                        {
                                            "name": "[variables('functionStorageAccountName')]",
                                            "type": "Microsoft.Storage/storageAccounts",
                                            "apiVersion": "2016-01-01",
                                            "location": "[parameters('regionId')]",
                                            "kind": "Storage",
                                            "sku": {
                                                "name": "Standard_LRS"
                                            }
                                        },
                                        {
                                            "name": "[variables('appServicePlanName')]",
                                            "type": "Microsoft.Web/serverFarms",
                                            "apiVersion": "2018-02-01",
                                            "location": "[parameters('regionId')]",
                                            "sku": {
                                                "name": "Y1",
                                                "tier": "Dynamic"
                                            },
                                            "properties": {
                                                "name": "[variables('appServicePlanName')]",
                                                "computeMode": "Dynamic"
                                            }
                                        },
                                        {
                                            "name": "[variables('functionAppName')]",
                                            "type": "Microsoft.Web/sites",
                                            "apiVersion": "2015-08-01",
                                            "location": "[parameters('regionId')]",
                                            "kind": "functionapp",
                                            "identity": {
                                                "type": "SystemAssigned"
                                            },
                                            "properties": {
                                                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]"
                                            },
                                            "resources": [
                                                {
                                                    "name": "default/eventGrid",
                                                    "type": "host/systemKeys",
                                                    "apiVersion": "2018-11-01",
                                                    "properties": {
                                                        "name": "eventGrid"
                                                    },
                                                    "dependsOn": [
                                                        "[resourceId('Microsoft.Web/sites', variables('functionAppName'))]"
                                                    ]
                                                }
                                            ],
                                            "dependsOn": [
                                                "[resourceId('Microsoft.Web/serverFarms', variables('appServicePlanName'))]",
                                                "[resourceId('Microsoft.Storage/storageAccounts', variables('functionStorageAccountName'))]"
                                            ]
                                        },
                                
                                        {
                                            "name": "[variables('mediaServicesName')]",
                                            "type": "Microsoft.Media/mediaServices",
                                            "apiVersion": "2018-07-01",
                                            "location": "[parameters('regionId')]",
                                            "properties": {
                                                "storageAccounts": [
                                                    {
                                                        "id": "[resourceId('Microsoft.Storage/storageAccounts', variables('mediaEncodingStorageAccountName'))]",
                                                        "type": "Primary"
                                                    }
                                                ]   
                                            },
                                            "dependsOn": [
                                                "[resourceId('Microsoft.Storage/storageAccounts', variables('mediaEncodingStorageAccountName'))]"
                                            ]
                                        },
                                        {
                                            "name": "[variables('mediaEncodingStorageAccountName')]",
                                            "type": "Microsoft.Storage/storageAccounts",
                                            "apiVersion": "2016-01-01",
                                            "location": "[parameters('regionId')]",
                                            "kind": "Storage",
                                            "sku": {
                                                "name": "Standard_LRS"
                                            }
                                        }
                                    ],
                                    "outputs": {
                                        "stampConfiguration": {
                                            "type": "object",
                                            "value": {
                                                "functionAppName": "[variables('functionAppName')]",
                                                "functionAppPrincipalId": "[reference(concat(resourceId('Microsoft.Web/sites', variables('functionAppName')), '/providers/Microsoft.ManagedIdentity/identities/default'), '2015-08-31-PREVIEW').principalId]",
                                                "functionStorageAccountName": "[variables('functionStorageAccountName')]",
                                                "mediaServicesResourceName": "[variables('mediaServicesName')]"
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    ],
                    "outputs": {
                        "stampConfigurations": {
                            "type": "array",
                            "copy": {
                                "count": "[length(parameters('stamps'))]",
                                "input": "[reference(resourceId('Microsoft.Resources/deployments', concat('stampTemplate-', parameters('stamps')[copyIndex()].resourceNameSuffix))).outputs.stampConfiguration.value]"
                            }
                        },
                        "functionAppPrincipalIds": {
                            "type": "array",
                            "copy": {
                                "count": "[length(parameters('stamps'))]",
                                "input": "[reference(resourceId('Microsoft.Resources/deployments', concat('stampTemplate-', parameters('stamps')[copyIndex()].resourceNameSuffix))).outputs.stampConfiguration.value.functionAppPrincipalId]"
                            }
                        },
                        "mediaServicesResourceNames": {
                            "type": "array",
                            "copy": {
                                "count": "[length(parameters('stamps'))]",
                                "input": "[reference(resourceId('Microsoft.Resources/deployments', concat('stampTemplate-', parameters('stamps')[copyIndex()].resourceNameSuffix))).outputs.stampConfiguration.value.mediaServicesResourceName]"
                            }
                        }
                    }
                }
            }
        },

        // Deploy Azure RBAC role assignments to grant function apps Contributor role on all Media Services instances.
        {
            "name": "[concat('roleAssignments-', parameters('stamps')[copyIndex('stampsRoleAssignmentsCopy')].resourceNameSuffix)]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-05-01",
            "copy": {
                "name": "stampsRoleAssignmentsCopy",
                "count": "[length(parameters('stamps'))]"
            },
            "properties": {
                "mode": "Incremental",
                "expressionEvaluationOptions": {
                    "scope": "inner"    
                },
                "parameters": {
                    "mediaServicesResourceName": {
                        "value": "[reference(resourceId('Microsoft.Resources/deployments', 'allStamps')).outputs.mediaServicesResourceNames.value[copyIndex('stampsRoleAssignmentsCopy')]]"
                    },
                    "functionAppPrincipalIds": {
                        "value": "[reference(resourceId('Microsoft.Resources/deployments', 'allStamps')).outputs.functionAppPrincipalIds.value]"
                    }
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "mediaServicesResourceName": {
                            "type": "string"
                        },
                        "functionAppPrincipalIds": {
                            "type": "array"
                        }
                    },
                    "variables": {
                        "contributorRoleDefinitionId": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Authorization/roleDefinitions/', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]"
                    },
                    "resources": [
                        {
                            "name": "[concat(parameters('mediaServicesResourceName'), '/Microsoft.Authorization/', guid(subscription().subscriptionId, resourceGroup().id, parameters('mediaServicesResourceName'), parameters('functionAppPrincipalIds')[copyIndex('functionPrincipalIdsCopy')]))]",
                            "type": "Microsoft.Media/mediaServices/providers/roleAssignments",
                            "apiVersion": "2018-09-01-preview",
                            "copy": {
                                "name": "functionPrincipalIdsCopy",
                                "count": "[length(parameters('functionAppPrincipalIds'))]"
                            },
                            "properties": {
                                "roleDefinitionId": "[variables('contributorRoleDefinitionId')]",
                                "principalId": "[parameters('functionAppPrincipalIds')[copyIndex('functionPrincipalIdsCopy')]]"
                            }
                        }
                    ]
                }
            },
            "dependsOn": [
                "allStamps"
            ]
        },

        // Deploy function app configuration settings, allowing the functions to refer to their own Media Services endpoint as well as all others.
        {
            "name": "[concat('functionSettings-', parameters('stamps')[copyIndex('stampsFunctionConfigurationCopy')].resourceNameSuffix)]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-05-01",
            "copy": {
                "name": "stampsFunctionConfigurationCopy",
                "count": "[length(parameters('stamps'))]"
            },
            "properties": {
                "mode": "Incremental",
                "expressionEvaluationOptions": {
                    "scope": "inner"    
                },
                "parameters": {
                    "stampConfiguration": {
                        "value": "[reference(resourceId('Microsoft.Resources/deployments', 'allStamps')).outputs.stampConfigurations.value[copyIndex('stampsFunctionConfigurationCopy')]]"
                    },
                    "allStampConfigurations": {
                        "value": "[reference(resourceId('Microsoft.Resources/deployments', 'allStamps')).outputs.stampConfigurations.value]"
                    },
                    "applicationInsightsInstrumentationKey": {
                        "value": "[reference(resourceId('Microsoft.Insights/components', variables('applicationInsightsResourceName'))).instrumentationKey]"
                    }
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "stampConfiguration": {
                            "type": "object"
                        },
                        "allStampConfigurations": {
                            "type": "array"
                        },
                        "applicationInsightsInstrumentationKey": {
                            "type": "string"
                        }
                    },
                    "variables": {
                        "functionStorageAccountId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('stampConfiguration').functionStorageAccountName)]",
                        "copy": [
                            {
                                "name": "allMediaServicesResourceNames",
                                "count": "[length(parameters('allStampConfigurations'))]",
                                "input": "[parameters('allStampConfigurations')[copyIndex('allMediaServicesResourceNames')].mediaServicesResourceName]"
                            }
                        ]
                    },
                    "resources": [
                        {
                            "name": "[concat(parameters('stampConfiguration').functionAppName, '/appsettings')]",
                            "type": "Microsoft.Web/sites/config",
                            "apiVersion": "2018-11-01",
                            "properties": {
                                "AzureWebJobsDashboard": "[concat('DefaultEndpointsProtocol=https;AccountName=', parameters('stampConfiguration').functionStorageAccountName, ';AccountKey=', listKeys(variables('functionStorageAccountId'),'2015-05-01-preview').key1)]",
                                "AzureWebJobsStorage": "[concat('DefaultEndpointsProtocol=https;AccountName=', parameters('stampConfiguration').functionStorageAccountName, ';AccountKey=', listKeys(variables('functionStorageAccountId'),'2015-05-01-preview').key1)]",
                                "AzureWebJobsSecretStorageType": "files",
                                "FUNCTIONS_EXTENSION_VERSION": "~3",
                                "APPINSIGHTS_INSTRUMENTATIONKEY": "[parameters('applicationInsightsInstrumentationKey')]",
                                "MediaServices:Endpoints:Primary": "[parameters('stampConfiguration').mediaServicesResourceName]",
                                "MediaServices:Endpoints:All": "[string(variables('allMediaServicesResourceNames'))]"
                            }
                        }
                    ]
                }
            },
            "dependsOn": [
                "allStamps",
                "[resourceId('Microsoft.Insights/components', variables('applicationInsightsResourceName'))]"
            ]
        }
    ]
}
